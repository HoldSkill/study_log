### 1. TCP 协议

tcp协议：是面向连接的，可靠的，基于字节流的传输层通讯协议

**tcp协议的特点是：**

- 基于连接的：数据传输之间需要建立连接
- 全双工：双向传输
- 字节流：不限制数据大小，打包成报文段，保证有序接收，重复报文自动丢弃
- 流量缓冲：解决双方处理能力的不匹配
- 可靠的传输层服务：保证可达，丢包时通过重发机制保证可靠性

**tcp连接：**

四元组：源地址，源端口，目的地址，目的端口

**tcp的报文格式：**

1. 源端口(source port)，这个端口一般是随机生成的
2. 目的端口(dest port) 
3. 序列号(sequence number)，应答号(acknowledgment number): **这两个可以保证数据的可靠性传输**
4. 头部长度（header length），保留字段（unused）,**报文标识(常用的有：SYN:标识建立连接的报文，ACK:表示响应的报文，FIN:表示断开连接的报文)**
5. receive window:表示当前服务器可以接收报文大小的值
6. urgent data pointer:紧急数据指针
7. options:可选参数
8. data:真正的数据

**tcp的三次握手：**

1. （**SYN=1, seq=x,SYN_SEND**）客户端发送一个SYN标识等于1的包，指明需要连接的目的地址，目的端口，源地址，源端口，序列号，应答号等信息，然后客户端处在`SYN_SEND`状态
2. (**SYN=1,ACK=1,seq=y,ack num=x+1，SYN_RCVD**)服务端发送确认（ACK）包，即SYN和ACK都为1，服务器选择自己的ISN序列号放在seq（序列号）里面，同时将应答号设置为客户端传过来的序列号+1，然后发送给客户端，服务端在`SYN_RCVD`状态
3. (**ACK =1,ack num = y+1,ESTABLISHED**)客户端再次发送确认包（ACK），SYN为0，ACK为1，并把服务器发过来的序列号+1放在应答号区域，发送给服务端，发送完毕后，客户端和服务端都处在`ESTABLISHED`状态

> 如果想要抓包，可以使用tckdump这个命令来抓包，具体用法自行查找
>
> 如果想要发送消息，可以在本地使用nc  命令发送
>
> 查看连接状态：netstat -ntp -c 1

**tcp的四次挥手**

1. **(FIN =1,seq=x, FIN_WAIT_1)**客户端发送 FIN数据包，表示不再发送数据了，想要关闭连接
2. **（ACK=1,ack num = x+1,CLOSE_WAIT,FIN_WAIT_2）**服务端接收到FIN包之后，发送一个ACK包，服务器在`CLOSE_WAIT`，客户端在`FIN_WAIT_2`，表示接收到客户端的关闭请求，服务端在准备关闭连接
3. **(FIN=1,seq= y, LAST_ACK)**服务端准备好关闭连接时，向客户端发送结束请求，FIN设置为1，发送完毕后，服务端在`LAST_ACK`状态，等待客户端最后一个ACK
4. **(ACK =1,ack num = y+1, TIME_WAIT,CLOSED,CLOSED)**客户端收到服务端的关闭请求，发送一个ACK包，进入`TIME_WAIT`状态，等待可能出现的要求重传的ACK包(等待一个来回的时间)，服务端接收到客户端的ACK包，进入`CLOSED`状态，客户端在等待固定时间后，也进入`CLOSED`状态

**注意：客户端在最后一次发送ACK包之后处于`TIME_WAIT`状态的原因是：为了防止服务端没有收到该ACK包，然后服务端会不停的向客户端FIN包请求关闭，浪费服务端资源，而且如果客户端新的连接使用了之前这个接口，就会对新建立的连接早晨混乱**



**字节流协议：**

TCP会把数据查分成多个报文段发送过去，每个报文段的大小默认时536字节，但是会根据对方给的串口值和网络拥堵情况决定真实的大小，正因为分成多个报文段传输，所以就不能保证各个报文段按顺序传输，接收端在接收到所有报文段之后会根据seq num(序列号)进行排序，如果没有收到会要求发送方重新传，如果收到重复的，会去重



> 重传机制，每发送一个报文，服务器会返回一个ACK，不管是客户端发送的报文丢失，还是服务器返回的ACK丢失，客户端都会在等待一定时间后重新发送报文

**数据可靠性**

- 第一种是：**停止等待协议，客户端发送一段报文，服务器返回一个ACK包，然后客户端继续发送（这种效率很低）**

- 第二种：**滑动窗口协议和累计确认（延迟ACK）：** 

  tcp会根据窗口大小发送一批报文，这里举例：一个窗口可以发送六个报文，如果1，2，3，4，5，6都发送过去，但是只有1，2，3收到ACK，4，5，6在等待ACK，这时就可以把窗口往后延续，发送7，8，9，如果5没有发送过去或者没收到ACK，就必须等待5确认，如果超时，那么就把5往后的重新发，以此类推，窗口不停往后移动

### 2. HTTP协议

http:超文本传输协议，是一种无状态的，以请求/应答方式运行的协议，它使用可扩展的语义和自描述消息格式，与基于网络的超文本信息系统灵活的互动

##### 2.1 http报文格式

- 起始行(start line): 描述请求和响应的基本信息

  请求起始行信息：

  - 请求方式（GET,POST...）
  - 请求目标：通常是一个URI，表示请求方法要操作的资源
  - Http版本号

  响应起始行信息：

  - http版本号
  - 状态码：如：200，500....等
  - 原因：作为数字状态码的补充，是更详细的解释文字，帮助人理解原因

- 头部字段集合(header)：使用key-value形式

  常用的header: 

  - 请求字段：host,referer(来源，防止盗链)
  - 响应字段：server,date
  - 通用字段：content-type,connection

- 空行

- 消息正文(entity): 实际传输的数据，它不一定是纯文本，可以是图片、视频等二级制数据